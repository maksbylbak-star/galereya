<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ì–∞–ª–µ—Ä–µ—è –Ω–∞—à–∏—Ö –∞–ª—å–±–æ–º—ñ–≤üíñ</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíñ</text></svg>">
<style>
@import url('https://fonts.googleapis.com/css2?family=Great+Vibes&family=Open+Sans:wght@300;400;600&display=swap');
:root{--bg1:#330d1a;--bg2:#4d0f2f;--accent:#ff99cc;--muted:#ffbed9}
*{box-sizing:border-box}
body{margin:0;font-family:'Open Sans',sans-serif;background:radial-gradient(circle at 30% 30%, var(--bg1),var(--bg2));color:var(--muted);min-height:100vh}
.container{max-width:980px;margin:28px auto;padding:20px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.title{font-family:'Great Vibes',cursive;color:var(--accent);font-size:2.6rem}
.controls{display:flex;gap:10px;align-items:center}
.btn{background:rgba(255,153,204,0.18);border:1px solid rgba(255,153,204,0.35);padding:8px 12px;border-radius:12px;color:var(--accent);cursor:pointer}
.btn:hover{transform:scale(1.03)}
.small{padding:6px 8px;border-radius:10px;font-size:0.95rem}

/* ALBUMS */
#albums-view{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:18px;margin-top:18px}
.album-card{position:relative;background:rgba(255,255,255,0.03);border-radius:14px;padding:10px;overflow:hidden;cursor:pointer;transition:transform .18s,box-shadow .18s}
.album-card:hover{transform:translateY(-6px);box-shadow:0 6px 18px rgba(0,0,0,0.4)}
.album-cover{width:100%;height:140px;object-fit:cover;border-radius:10px;background:#220912}
.album-meta{padding:8px 6px;text-align:center}
.album-name{font-weight:600;color:#ffd1e6}
.album-count{font-size:0.85rem;color:#ffc8da;margin-top:6px}
.album-actions{position:absolute;top:8px;right:8px;display:flex;gap:6px}
.icon-btn{width:34px;height:34px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
.icon-edit{background:#ff99cc;color:#3b0020}
.icon-del{background:#ff3b6b;color:white}

/* PHOTOS */
#photos-section{display:none;margin-top:16px}
.back-btn{color:var(--accent);cursor:pointer;margin-bottom:10px}
.album-title{font-family:'Great Vibes',cursive;color:var(--accent);font-size:1.8rem;margin:6px 0}
.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-top:10px}
.photo-card{position:relative;background:rgba(255,255,255,0.02);padding:10px;border-radius:12px}
.photo-card img{width:100%;height:220px;object-fit:cover;border-radius:8px;display:block}
.photo-desc{margin-top:8px;color:#ffc8da;font-size:0.95rem;min-height:1.2em}
.delete-btn{position:absolute;top:10px;right:10px;width:36px;height:36px;border-radius:50%;border:none;background:rgba(255,0,70,0.9);color:white;cursor:pointer}

/* MODALS */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1200}
.modal-box{background:#2b0a1a;padding:18px;border-radius:12px;width:92%;max-width:420px;color:var(--muted);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.modal-box h3{margin:0 0 10px 0;color:var(--accent);font-family:'Great Vibes',cursive}
.input{width:100%;padding:10px;border-radius:10px;border:none;margin:8px 0}
.modal-actions{display:flex;gap:8px;justify-content:center;margin-top:10px}

/* IMAGE VIEWER */
.viewer-img{max-width:90vw;max-height:80vh;border-radius:12px}
.viewer-close{position:absolute;top:16px;right:22px;font-size:28px;color:#fff;cursor:pointer}

/* MUSIC PLAYER */
#music-player{position:fixed;bottom:0;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.4);padding:8px 14px;border-radius:12px;display:flex;align-items:center;gap:8px;z-index:1000}

/* toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:70px;background:rgba(0,0,0,0.6);padding:8px 14px;border-radius:10px;display:none}

.note{font-size:0.95rem;color:#ffd9e9;margin-top:8px;cursor:pointer;}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">–ù–∞—à—ñ –∞–ª—å–±–æ–º–∏üíñ</div>
    <div class="controls">
      <button class="btn" id="btn-show-albums">–ê–ª—å–±–æ–º–∏</button>
      <button class="btn" id="btn-add-album">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–ª—å–±–æ–º</button>
    </div>
  </div>

  <div id="albums-section">
    <div id="albums-view"></div>
    <div class="note" id="main-note">–ú–∏ —Ç–∞ –Ω–∞—à—ñ —Å–ø–æ–≥–∞–¥–∏ –∑ –ø—Ä–∏–Ω—Ü–µ—Å–æ—éüíó.</div>
  </div>

  <div id="photos-section">
    <div class="back-btn" id="back-to-albums">‚¨Ö –ù–∞–∑–∞–¥ –¥–æ –∞–ª—å–±–æ–º—ñ–≤</div>
    <div class="album-title" id="current-album-name"></div>
    <div style="margin:8px 0"><button class="btn" id="btn-add-photo">‚ûï –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</button></div>
    <div class="photo-grid" id="photo-grid"></div>
  </div>
</div>

<!-- MODALS -->
<div class="modal" id="modal-add-album">
  <div class="modal-box">
    <h3>–ù–æ–≤–∏–π –∞–ª—å–±–æ–º</h3>
    <input class="input" id="input-album-name" placeholder="–ù–∞–∑–≤–∞ –∞–ª—å–±–æ–º—É" />
    <input class="input" id="input-album-cover" type="file" accept="image/*" />
    <div class="modal-actions">
      <button class="btn" id="save-album">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
      <button class="btn" id="cancel-album">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-add-photo">
  <div class="modal-box">
    <h3>–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</h3>
    <input class="input" id="input-photo-file" type="file" accept="image/*" />
    <input class="input" id="input-photo-desc" placeholder="–û–ø–∏—Å (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" />
    <div class="modal-actions">
      <button class="btn" id="save-photo">–î–æ–¥–∞—Ç–∏</button>
      <button class="btn" id="cancel-photo">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-edit-album">
  <div class="modal-box">
    <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∞–ª—å–±–æ–º</h3>
    <input class="input" id="edit-album-name" placeholder="–ù–æ–≤–∞ –Ω–∞–∑–≤–∞" />
    <input class="input" id="edit-album-cover" type="file" accept="image/*" />
    <div class="modal-actions">
      <button class="btn" id="save-edit-album">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <button class="btn" id="cancel-edit-album">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-view-image">
  <div style="position:relative">
    <span class="viewer-close" id="viewer-close">&times;</span>
    <img class="viewer-img" id="viewer-img" src="" alt="" />
  </div>
</div>

<!-- –ú—É–∑–∏–∫–∞ -->
<div id="music-player">
  <input type="file" id="music-file" accept="audio/*"/>
  <audio id="bg-music" controls></audio>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAj1aM_i39eq42FdFUw9-QZeq0gJhQwb-E",
  authDomain: "galereya-ani.firebaseapp.com",
  projectId: "galereya-ani",
  storageBucket: "galereya-ani.appspot.com",
  messagingSenderId: "564788961310",
  appId: "1:564788961310:web:64512d257bca9aaa18ce0f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// –°—Ç–∞–Ω
let currentAlbumId = null;
let editingAlbumId = null;
const placeholder = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='%23220a12'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='48' fill='%23ff99cc'>–ê–ª—å–±–æ–º</text></svg>";

// –ï–ª–µ–º–µ–Ω—Ç–∏
const albumsView = document.getElementById('albums-view');
const photoGrid = document.getElementById('photo-grid');
const mainNote = document.getElementById('main-note');

// --- –ú—É–∑–∏–∫–∞ ---
const musicFile = document.getElementById('music-file');
const bgMusic = document.getElementById('bg-music');
musicFile.addEventListener('change', ()=>{
  const file = musicFile.files[0];
  if(file){
    const url = URL.createObjectURL(file);
    bgMusic.src = url;
    bgMusic.play();
  }
});

// --- UI ---
const btnAddAlbum = document.getElementById('btn-add-album');
const modalAddAlbum = document.getElementById('modal-add-album');
const inputAlbumName = document.getElementById('input-album-name');
const inputAlbumCover = document.getElementById('input-album-cover');
const btnSaveAlbum = document.getElementById('save-album');
const btnCancelAlbum = document.getElementById('cancel-album');

const btnAddPhoto = document.getElementById('btn-add-photo');
const modalAddPhoto = document.getElementById('modal-add-photo');
const inputPhotoFile = document.getElementById('input-photo-file');
const inputPhotoDesc = document.getElementById('input-photo-desc');
const btnSavePhoto = document.getElementById('save-photo');
const btnCancelPhoto = document.getElementById('cancel-photo');

const modalEditAlbum = document.getElementById('modal-edit-album');
const inputEditAlbumName = document.getElementById('edit-album-name');
const inputEditAlbumCover = document.getElementById('edit-album-cover');
const btnSaveEditAlbum = document.getElementById('save-edit-album');
const btnCancelEditAlbum = document.getElementById('cancel-edit-album');

const modalViewImage = document.getElementById('modal-view-image');
const viewerImg = document.getElementById('viewer-img');
const viewerClose = document.getElementById('viewer-close');

const toast = document.getElementById('toast');
function showToast(text){ toast.textContent = text; toast.style.display = 'block'; setTimeout(()=> toast.style.display='none',2200); }
function openModal(modal){ modal.style.display = 'flex'; }
function closeModal(modal){ modal.style.display = 'none'; }

// --- ALBUMS ---
function renderAlbums(){
  albumsView.innerHTML = '';
  db.collection('albums').orderBy('createdAt','desc').get().then(snapshot=>{
    if(snapshot.empty){ albumsView.innerHTML = '<div style="text-align:center;color:#ffc8da">–ü—É—Å—Ç–æ ‚Äî —Å—Ç–≤–æ—Ä–∏ –∞–ª—å–±–æ–º</div>'; return; }
    snapshot.forEach(doc=>{
      const data = doc.data();
      const card = document.createElement('div');
      card.className = 'album-card';
      const cover = data.coverUrl || placeholder;
      card.innerHTML = `
        <div class="album-actions">
          <button class="icon-btn icon-edit" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</button>
          <button class="icon-btn icon-del" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóë</button>
        </div>
        <img class="album-cover" src="${cover}" alt="cover" />
        <div class="album-meta">
          <div class="album-name">${escapeHtml(data.name)}</div>
          <div class="album-count" id="count-${doc.id}">–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>
      `;
      card.addEventListener('click',()=> openAlbum(doc.id, data.name));
      card.querySelector('.icon-del').addEventListener('click', (e)=>{ e.stopPropagation(); deleteAlbum(doc.id); });
      card.querySelector('.icon-edit').addEventListener('click', (e)=>{ e.stopPropagation(); openEditAlbum(doc.id, data); });
      albumsView.appendChild(card);
      db.collection('albums').doc(doc.id).collection('photos').get().then(s=>{
        const el = document.getElementById(`count-${doc.id}`);
        if(el) el.textContent = s.size + ' —Ñ–æ—Ç–æ';
      }).catch(()=>{});
    });
  }).catch(err=>{ console.error(err); showToast('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–ª—å–±–æ–º—ñ–≤'); });
}
renderAlbums();

function openAlbum(id,name){
  currentAlbumId = id;
  document.getElementById('albums-section').style.display = 'none';
  document.getElementById('photos-section').style.display = 'block';
  document.getElementById('current-album-name').textContent = name;
  renderPhotos();
}
document.getElementById('back-to-albums').addEventListener('click', ()=>{
  currentAlbumId = null;
  document.getElementById('photos-section').style.display = 'none';
  document.getElementById('albums-section').style.display = 'block';
});

function deleteAlbum(id){
  if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∞–ª—å–±–æ–º? –£—Å—ñ —Ñ–æ—Ç–æ —Ç–∞–∫–æ–∂ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ.')) return;
  const ref = db.collection('albums').doc(id);
  ref.collection('photos').get().then(s=>{
    const batch = db.batch();
    s.forEach(doc=> batch.delete(ref.collection('photos').doc(doc.id)));
    batch.commit().then(()=> ref.delete().then(()=> showToast('–ê–ª—å–±–æ–º –≤–∏–¥–∞–ª–µ–Ω–æ')).then(()=> renderAlbums()))
    .catch(err=>{ console.error(err); showToast('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —Ñ–æ—Ç–æ'); });
  }).catch(err=>{ console.error(err); showToast('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∞–ª—å–±–æ–º—É'); });
}

function openEditAlbum(id,data){
  editingAlbumId = id;
  inputEditAlbumName.value = data.name || '';
  inputEditAlbumCover.value = null;
  openModal(modalEditAlbum);
}
btnSaveEditAlbum.addEventListener('click', ()=>{
  const newName = inputEditAlbumName.value.trim();
  const file = inputEditAlbumCover.files[0];
  if(!newName && !file){ showToast('–ù—ñ—á–æ–≥–æ –Ω–µ –∑–º—ñ–Ω–µ–Ω–æ'); closeModal(modalEditAlbum); return; }
  if(file){
    const r = new FileReader();
    r.onload = e=>{
      db.collection('albums').doc(editingAlbumId).update({ name:newName || undefined, coverUrl:e.target.result }).then(()=>{ showToast('–ê–ª—å–±–æ–º –æ–Ω–æ–≤–ª–µ–Ω–æ'); closeModal(modalEditAlbum); renderAlbums(); }).catch(err=>{ console.error(err); showToast('–ü–æ–º–∏–ª–∫–∞'); });
    };
    r.readAsDataURL(file);
  } else {
    db.collection('albums').doc(editingAlbumId).update({ name:newName }).then(()=>{ showToast('–ê–ª—å–±–æ–º –æ–Ω–æ–≤–ª–µ–Ω–æ'); closeModal(modalEditAlbum); renderAlbums(); }).catch(err=>{ console.error(err); showToast('–ü–æ–º–∏–ª–∫–∞'); });
  }
});
btnCancelEditAlbum.addEventListener('click', ()=> closeModal(modalEditAlbum));

// --- PHOTOS ---
function renderPhotos(){
  photoGrid.innerHTML = '';
  if(!currentAlbumId) return;
  db.collection('albums').doc(currentAlbumId).collection('photos').orderBy('timestamp','asc').get().then(snapshot=>{
    if(snapshot.empty){ photoGrid.innerHTML = '<div style="text-align:center;color:#ffc8da">–£ —Ü—å–æ–º—É –∞–ª—å–±–æ–º—ñ –Ω–µ–º–∞—î —Ñ–æ—Ç–æ</div>'; return; }
    snapshot.forEach(doc=>{
      const p = doc.data();
      const pc = document.createElement('div'); pc.className='photo-card';
      const url = p.url || '';
      const desc = p.desc || '';
      const img = document.createElement('img'); img.alt = desc; img.loading='lazy';
      img.src = url.startsWith('data:image') ? url : placeholder;
      img.onerror = ()=>{ img.src = placeholder; };
      const descDiv = document.createElement('div'); descDiv.className='photo-desc'; descDiv.textContent = desc;
      const delBtn = document.createElement('button'); delBtn.className='delete-btn'; delBtn.title='–í–∏–¥–∞–ª–∏—Ç–∏'; delBtn.textContent='üóë';
      img.addEventListener('click', ()=>{ openViewer(url, desc); });
      delBtn.addEventListener('click', (e)=>{ e.stopPropagation(); deletePhoto(doc.id); });
      pc.appendChild(img);
      pc.appendChild(delBtn);
      pc.appendChild(descDiv);
      photoGrid.appendChild(pc);
    });
  }).catch(err=>{ console.error(err); showToast('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ'); });
}

// --- –î–æ–¥–∞—Ç–∏ –∞–ª—å–±–æ–º ---
btnAddAlbum.addEventListener('click', ()=>{ inputAlbumName.value=''; inputAlbumCover.value=null; openModal(modalAddAlbum); });
btnCancelAlbum.addEventListener('click', ()=> closeModal(modalAddAlbum));
btnSaveAlbum.addEventListener('click', ()=>{
  const name = inputAlbumName.value.trim(); const file = inputAlbumCover.files[0];
  if(!name){ alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É'); return; }
  if(file){ const r = new FileReader(); r.onload = e=>{ db.collection('albums').add({ name:name, coverUrl:e.target.result, createdAt: firebase.firestore.FieldValue.serverTimestamp() }).then(()=>{ showToast('–ê–ª—å–±–æ–º —Å—Ç–≤–æ—Ä–µ–Ω–æ'); closeModal(modalAddAlbum); renderAlbums(); }).catch(err=>{ console.error(err); showToast('–ü–æ–º–∏–ª–∫–∞'); }); }; r.readAsDataURL(file); }
  else{ db.collection('albums').add({ name:name, coverUrl:placeholder, createdAt: firebase.firestore.FieldValue.serverTimestamp() }).then(()=>{ showToast('–ê–ª—å–±–æ–º —Å—Ç–≤–æ—Ä–µ–Ω–æ'); closeModal(modalAddAlbum); renderAlbums(); }).catch(err=>{ console.error(err); showToast('–ü–æ–º–∏–ª–∫–∞'); }); }
});

// --- –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ ---
btnAddPhoto.addEventListener('click', ()=>{ if(!currentAlbumId){ alert('–û–±–µ—Ä—ñ—Ç—å –∞–ª—å–±–æ–º'); return; } inputPhotoFile.value=null; inputPhotoDesc.value=''; openModal(modalAddPhoto); });
btnCancelPhoto.addEventListener('click', ()=> closeModal(modalAddPhoto));
btnSavePhoto.addEventListener('click', ()=>{
  const file = inputPhotoFile.files[0]; const desc = inputPhotoDesc.value.trim();
  if(!file){ alert('–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª'); return; }
  const r = new FileReader(); r.onload = e=>{
    const dataUrl = e.target.result;
    db.collection('albums').doc(currentAlbumId).collection('photos').add({ url:dataUrl, desc:desc, timestamp: firebase.firestore.FieldValue.serverTimestamp() }).then(()=>{ showToast('–§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ'); closeModal(modalAddPhoto); renderPhotos(); renderAlbums(); }).catch(err=>{ console.error(err); showToast('–ü–æ–º–∏–ª–∫–∞'); });
  };
  r.readAsDataURL(file);
});

// --- –í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ—Ç–æ ---
function deletePhoto(id){
  if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ—Ç–æ?')) return;
  db.collection('albums').doc(currentAlbumId).collection('photos').doc(id).delete()
    .then(()=>{ showToast('–§–æ—Ç–æ –≤–∏–¥–∞–ª–µ–Ω–æ'); renderPhotos(); renderAlbums(); })
    .catch(err=>{ console.error(err); showToast('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —Ñ–æ—Ç–æ'); });
}

// --- –ü–µ—Ä–µ–≥–ª—è–¥ —Ñ–æ—Ç–æ ---
function openViewer(url,desc){ viewerImg.src = url || placeholder; openModal(modalViewImage); }
viewerClose.addEventListener('click', ()=>{ viewerImg.src=''; closeModal(modalViewImage); });

// --- –ù–æ—Ç–∞—Ç–∫–∞ ---
mainNote.addEventListener('click', ()=>{
  const newText = prompt('–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –Ω–æ—Ç–∞—Ç–∫—É:', mainNote.textContent);
  if(newText !== null){
    mainNote.textContent = newText;
  }
});

// --- –∫–æ—Ä–∏—Å–Ω—ñ ---
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }
window.addEventListener('click',(e)=>{ ['modal-add-album','modal-add-photo','modal-edit-album','modal-view-image'].forEach(id=>{ const el=document.getElementById(id); if(el && e.target===el) el.style.display='none'; }); });
document.getElementById('btn-show-albums').addEventListener('click', ()=>{ document.getElementById('photos-section').style.display='none'; document.getElementById('albums-section').style.display='block'; currentAlbumId=null; });
</script>
</body>
</html>
